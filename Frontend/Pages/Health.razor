@page "/health"
@inject Frontend.Services.HealthApiService HealthService
@inject Frontend.Services.ChatSignalRService ChatService

<PageTitle>Health check</PageTitle>

<h1>Health check</h1>

@if (vm == null)
{
    <p>Loading...</p>
}
else
{
    <p>@((MarkupString)vm.StatusMessage)</p>

    <div class="mt-3">
        <input class="form-control"
               placeholder="Type a message..."
               @bind="vm.CurrentMessage" />

        <button class="btn btn-primary mt-2" @onclick="SendMessage">
            Send message
        </button>
    </div>
}

@code {
    private Frontend.ViewModels.HealthViewModel? vm;

    protected override async Task OnInitializedAsync()
    {
        vm = new Frontend.ViewModels.HealthViewModel(HealthService, ChatService);

        vm.OnStateChanged += () =>
        {
            InvokeAsync(StateHasChanged);
        };

        await vm.LoadHealthAsync();
        await vm.StartChatAsync();

        StateHasChanged();
    }

    private async Task SendMessage()
    {
        if (vm != null)
        {
            await vm.SendMessageAsync();
            StateHasChanged();
        }
    }
}
