@using Frontend.Models
@using Frontend.ViewModels
@using Microsoft.AspNetCore.Components
@using Shared.DTOs

@inherits UserViewModel;

@if (ShowEditUserDialog)
{
    <div class="modal-backdrop"></div>

    <div class="modal show d-block">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Edit User</h5>
                    <button class="btn-close" @onclick="Cancel"></button>
                </div>                

                <div class="modal-body">

                    <label class="mt-2">Login</label>
                    <input class="form-control"
                           type="text"
                           @bind="LocalUser.Login" />

                    <label class="mt-2">Full Name</label>
                    <input class="form-control"
                           type="text"
                           @bind="LocalUser.FullName" />

                    <div class="form-check mt-3">
                        <input class="form-check-input"
                               type="checkbox"
                               id="updatePasswordCheck"
                               @bind="UpdatePassword" />
                        <label class="form-check-label" for="updatePasswordCheck">
                            Update password
                        </label>
                    </div>

                    @if (@UpdatePassword)
                    {

                        <label class="mt-2">Current Password</label>
                        <div class="input-group">
                            <input class="form-control"
                            type=@(showPassword[PwdField.Current] ? "text" : "password")
                            @bind="LocalUser.CurrentPassword" />

                            <button type="button"
                            class="btn btn-outline-secondary"
                            @onclick='() => TogglePasswordVisibility(PwdField.Current)'
                            tabindex="-1">
                                <i class="bi @(showPassword[PwdField.Current] ? "bi-eye-slash" : "bi-eye")"></i>
                            </button>
                        </div>


                        <label class="mt-2">New Password</label>
                        <div class="input-group">
                            <input class="form-control"
                            type=@(showPassword[PwdField.New] ? "text" : "password")
                            @bind="LocalUser.NewPassword" />

                            <button type="button"
                            class="btn btn-outline-secondary"
                            @onclick='() => TogglePasswordVisibility(PwdField.New)'
                            tabindex="-1">
                                <i class="bi @(showPassword[PwdField.New] ? "bi-eye-slash" : "bi-eye")"></i>
                            </button>
                        </div>


                        <label class="mt-2">Confirm Password</label>
                        <div class="input-group">
                            <input class="form-control"
                            type=@(showPassword[PwdField.Confirm] ? "text" : "password")
                            @bind="LocalUser.ConfirmPassword" />

                            <button type="button"
                            class="btn btn-outline-secondary"
                            @onclick='() => TogglePasswordVisibility(PwdField.Confirm)'
                            tabindex="-1">
                                <i class="bi @(showPassword[PwdField.Confirm] ? "bi-eye-slash" : "bi-eye")"></i>
                            </button>
                        </div>
                    }
                </div>

                <div class="modal-footer">
                    <button class="btn btn-danger" @onclick="Delete">Delete user</button>
                    <button class="btn btn-primary" @onclick="Submit">Submit</button>
                </div>

            </div>
        </div>
    </div>

    <InfoDialog Show="@ShowInfoDialog"
                Title="@InfoTitle"
                Message="@InfoMessage"
                OnClose="() => ShowInfoDialog = false" />
}


@code {
    [Parameter] public bool UpdatePassword { get; set; } = false;
    [Parameter] public EventCallback<EditUser> OnSubmit { get; set; }
    [Parameter] public EventCallback<EditUser> OnDelete { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    private EditUser LocalUser = new();

    private bool ShowInfoDialog { get; set; }

    private string? InfoTitle { get; set; }

    private string? InfoMessage { get; set; }

    private void RaiseInfoDlg( string sTitle, string sMsg)
    {
        InfoTitle = sTitle;
        InfoMessage = sMsg;
        ShowInfoDialog = true;
    }

    protected override void OnParametersSet()
    {
        Console.WriteLine("Called OnParametersSet - clone user");
        if (SelectedUser == null)
            return;

        // COPY values (no live reference)
        LocalUser = new EditUser
        {
            Id = SelectedUser.Id,
            Login = SelectedUser.Login,
            FullName = SelectedUser.FullName
        };

        Console.WriteLine( "Clone no good:" + 
            Object.ReferenceEquals(SelectedUser, LocalUser) );
    }

    public async Task Cancel()
        => await OnCancel.InvokeAsync();

    private bool ValidateInput()
    {
        if (string.IsNullOrEmpty(LocalUser.Login))
        {
            RaiseInfoDlg("Login field Error", "Login  field cannot be empty!");
            return false;
        }

        if (string.IsNullOrEmpty(LocalUser.FullName))
        {
            RaiseInfoDlg("Full Name field Error", "Full Name  field cannot be empty!");
            return false;
        }

        if (!UpdatePassword)
            return true;

        if( string.IsNullOrEmpty(LocalUser.CurrentPassword ) || 
            string.IsNullOrEmpty(LocalUser.NewPassword) ||
            string.IsNullOrEmpty(LocalUser.ConfirmPassword) )
        {
            RaiseInfoDlg("Password field Error", "No Password field can be empty!");
            return false;
        }

        if( LocalUser.NewPassword != LocalUser.ConfirmPassword )
        {
            RaiseInfoDlg("New Password mismatch", "New Password and Confirm Password do not match!");
            return false;
        }


        return true;
    }

    public async Task Submit() 
    {
        if (!ValidateInput())
            return;

        LocalUser.IsPasswordUpdated = UpdatePassword;
        await OnSubmit.InvokeAsync(LocalUser);
    }

    public async Task Delete()
    {
        await OnDelete.InvokeAsync(LocalUser);
    }

    #region PasswordVisibilty 

    private enum PwdField
    {
        Current,
        New,
        Confirm
    }

    private Dictionary<PwdField, bool> showPassword = new()
    {
        { PwdField.Current, false },
        { PwdField.New, false },
        { PwdField.Confirm, false }
    };

    private void TogglePasswordVisibility(PwdField field)
    {
        if (showPassword.ContainsKey(field))
        {
            showPassword[field] = !showPassword[field];
        }
    }
    #endregion
}

